<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prenotazioni Colazione</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>

  <style>
    :root {
      --bg: #fefcf8;
      --card: #fff;
      --accent: #94d3ac;
      --danger: #e63946;
      --text: #333;
      --muted: #777;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Nunito', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    h1 {
      font-size: 2.2rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    h2 {
      margin-bottom: 0.2rem;
    }
    .container {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      align-items: flex-start;
      flex-wrap: nowrap; /* impedisce il wrap a capo */
      width: 100%;
      box-sizing: border-box;
    }
    .container > .card:first-child {
      flex: 0 0 30%;
      max-width: 30%;
    }
    .container > .card:last-child {
      flex: 1 1 65%;
      max-width: 65%;
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    input,
    select,
    textarea,
    button {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-top: 0.3rem;
      font-family: inherit;
      font-size: 1rem;
    }
    button {
      margin-top: 1rem;
      background-color: var(--accent);
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #82c496;
    }
    #breakfastList {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .booking-card {
      flex: 0 0 48%; /* larghezza per stare due per riga */
      box-sizing: border-box;
      background: #fff;
      border: 1px solid #f0e9dc;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .booking-card h3 {
      margin: 0 0 0.5rem 0;
      font-weight: 700;
    }
    .booking-card .actions {
      text-align: right;
    }
    .booking-card .delete-button {
      color: var(--danger);
      cursor: pointer;
      font-size: 0.9rem;
    }
    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .header-bar {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .active-days-card {
      background: #fef9f2;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin-top: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }
    #activeDaysContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    #activeDaysContainer button {
      width: auto;
      padding: 0.3rem 0.6rem;
      border: 1px solid #f0e9dc;
      background: #fffaf0;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      white-space: nowrap;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    #activeDaysContainer button.selected {
      background-color: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Nuovo CSS per la barra di saturazione */
    .booking-summary {
      margin-bottom: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .booking-summary span {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .progress-bar {
      width: 100%;
      height: 14px;
      background: #d5e7d5; /* verde chiaro */
      border-radius: 7px;
      overflow: hidden;
      box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.1);
    }
    .progress-bar.full {
      background: #f8d7da; /* rosso chiaro */
    }
    .progress-fill {
      height: 100%;
      background-color: #4caf50; /* verde */
      transition: width 0.3s ease;
    }
    .progress-bar.full .progress-fill {
      background-color: #e63946; /* rosso acceso */
    }
  </style>
</head>
<body>
  <div
    id="birthdayBanner"
    style="display: none; font-size: 1.5rem; color: var(--accent); text-align: center; margin-bottom: 1rem;"
  >
    üéâ Buon compleanno Silvia! üéâ
  </div>

  <div class="header-bar">
    <h1>üç¥ Prenotazioni colazione</h1>
    <label
      for="date"
      style="
        background-color: #fffaf0;
        color: #555;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        cursor: pointer;
        user-select: none;
      "
    >
      <img
        src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png"
        alt="calendario"
        style="width: 18px; height: 18px;"
      />
      <input
        type="date"
        id="date"
        style="border: none; background: transparent; color: #555; font-size: 1rem; cursor: pointer; padding: 0; margin: 0; width: auto;"
      />
    </label>
  </div>

  <div class="active-days-card">
    <h2>Giorni con Prenotazioni Attive</h2>
    <p class="muted">Seleziona un giorno per visualizzare o modificare le prenotazioni.</p>
    <div id="activeDaysContainer"></div>
  </div>

  <div class="container">
    <div class="card">
      <h2>Aggiungi Nuova Colazione</h2>
      <p class="muted" id="formDateDesc"></p>
      <form id="breakfastForm">
        <label>
          Ospite
          <input type="text" id="ownerName" placeholder="Filemazio" required />
        </label>

        <div
          style="
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: nowrap;
          "
        >
          <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
            <label
              style="display: flex; align-items: center; gap: 0.4rem; font-weight: 600; cursor: pointer;"
            >
              <span>üë§</span>
              <span>Adulti</span>
            </label>
            <input
              type="number"
              id="numAdults"
              min="0"
              max="15"
              value="1"
              required
              style="width: 100%; margin-top: 0.3rem;"
            />
          </div>

          <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
            <label
              style="display: flex; align-items: center; gap: 0.4rem; font-weight: 600; cursor: pointer;"
            >
              <span>üë∂</span>
              <span>Bambini</span>
            </label>
            <input
              type="number"
              id="numChildren"
              min="0"
              max="15"
              value="0"
              required
              style="width: 100%; margin-top: 0.3rem;"
            />
          </div>
        </div>

        <label style="margin-top: 1rem;">
          Fascia Oraria
          <select id="timeSlot">
            <option value="07:30">07:30</option>
            <option value="08:00">08:00</option>
            <option value="08:30">08:30</option>
            <option value="09:00">09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
          </select>
        </label>

        <label style="margin-top: 1rem;">
          Note (opzionale)
          <textarea id="notes"></textarea>
        </label>

        <button type="submit" style="margin-top: 1rem;">Aggiungi</button>
      </form>
    </div>

    <div class="card">
      <h2>Programma Giornaliero</h2>
      <p class="muted" id="summary"></p>
      <div id="breakfastList"></div>
    </div>
  </div>

  <script>
    const SHEET_URL =
      "https://script.google.com/macros/s/AKfycbwcurABKsq7rzY3lnBvsL0enJb7JNMTOjqNcd5wJ4YoE8X0_-ufQ1xqYM8pSCNJZ7xV/exec";

    // Recupera dati da Google Sheet
    async function getData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        return Array.isArray(data) ? data : [];
      } catch (e) {
        console.error("Errore caricamento dati:", e);
        return [];
      }
    }

    async function renderList() {
      const list = document.getElementById("breakfastList");
      const date = document.getElementById("date").value;
      const allData = await getData();
      const data = allData.filter((b) => b.date === date);
      const summary = document.getElementById("summary");
      const totalBreakfasts = data.reduce((s, b) => s + parseInt(b.numBreakfasts), 0);
      summary.textContent = `Panoramica per ${date.split("-").reverse().join(
        "/"
      )}. Colazioni Totali: ${totalBreakfasts}`;
      list.innerHTML = "";

      const slots = ["07:30", "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30"];
      const maxPerSlot = 15;

      slots.forEach((slot, i) => {
        const bookings = data.filter((b) => b.timeSlot === slot);
        if (bookings.length > 0) {
          const totalBooked = bookings.reduce((sum, b) => sum + parseInt(b.numBreakfasts), 0);
          const remaining = maxPerSlot - totalBooked;
          const prenotataText = totalBooked === 1 ? "prenotata" : "prenotate";
          let nextSlot = slots[i + 1] || slot;

          const slotDiv = document.createElement("div");
          slotDiv.className = "booking-card";
          slotDiv.style.width = "48%";
          slotDiv.style.backgroundColor = "#fff"; // bianco
          slotDiv.style.border = "2px solid #fffaf0"; // bordo giallino
          slotDiv.style.padding = "1rem";
          slotDiv.style.borderRadius = "12px";
          slotDiv.style.boxSizing = "border-box";

          // Header fascia oraria e info
          const headerHTML = `
            <h3>${slot} - ${nextSlot}</h3>
            <span>${totalBooked} ${prenotataText} / ${remaining} rimanenti</span>
            <div class="progress-bar" style="
              background-color: ${remaining === 0 ? "red" : "green"};
              height: 12px;
              border-radius: 6px;
              margin-top: 6px;
              width: ${(totalBooked / maxPerSlot) * 100}%;
              transition: width 0.3s ease;
            "></div>
          `;

          slotDiv.innerHTML = headerHTML;

          // Container per sotto-schede prenotazioni
          const bookingsContainer = document.createElement("div");
          bookingsContainer.style.marginTop = "1rem";
          bookingsContainer.style.display = "flex";
          bookingsContainer.style.flexDirection = "column";
          bookingsContainer.style.gap = "0.5rem";

          bookings.forEach((b) => {
            const subCard = document.createElement("div");
            subCard.style.backgroundColor = "#fffaf0"; // giallino app
            subCard.style.padding = "0.6rem 1rem";
            subCard.style.borderRadius = "8px";
            subCard.style.boxShadow = "inset 0 0 5px rgba(0,0,0,0.05)";
            subCard.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center; font-weight: bold;">
                ${b.ownerName}
              </div>
              <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.3rem; font-size: 0.95rem;">
                <span>üë§ ${b.numAdults}</span>
                <span>üë∂ ${b.numChildren}</span>
                <span>üçΩÔ∏è ${b.numBreakfasts}</span>
              </div>
            `;
            bookingsContainer.appendChild(subCard);
          });

          slotDiv.appendChild(bookingsContainer);
          list.appendChild(slotDiv);
        }
      });
    }

    async function renderActiveDays() {
      const container = document.getElementById("activeDaysContainer");
      const all = await getData();
      const uniqueDates = [...new Set(all.map((b) => b.date))].sort();
      const currentDate = document.getElementById("date").value;

      container.innerHTML = "";
      uniqueDates.forEach((date) => {
        const btn = document.createElement("button");
        const [y, m, d] = date.split("-");
        btn.textContent = `${parseInt(d)} ${new Date(date).toLocaleString("it-IT", {
          month: "short",
          year: "numeric",
        })}`;
        if (date === currentDate) btn.classList.add("selected");
        btn.onclick = () => {
          document.getElementById("date").value = date;
          document.getElementById("date").dispatchEvent(new Event("change"));
        };
        container.appendChild(btn);
      });
    }

    document.getElementById("breakfastForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const date = document.getElementById("date").value;
      const ownerName = document.getElementById("ownerName").value.trim();
      const numAdults = parseInt(document.getElementById("numAdults").value);
      const numChildren = parseInt(document.getElementById("numChildren").value);
      const timeSlot = document.getElementById("timeSlot").value;
      const notes = document.getElementById("notes").value.trim();
      const numBreakfasts = numAdults + numChildren;

      if (!ownerName) {
        alert("Inserisci il nome dell'ospite.");
        return;
      }
      if (numBreakfasts === 0) {
        alert("Inserisci almeno un adulto o un bambino.");
        return;
      }

      const all = await getData();
      const currentBookings = all.filter((b) => b.date === date && b.timeSlot === timeSlot);
      const totalPeopleInSlot = currentBookings.reduce((sum, b) => sum + parseInt(b.numBreakfasts), 0);

      if (totalPeopleInSlot + numBreakfasts > 15) {
        alert(`Limite raggiunto: massimo 15 persone per la fascia ${timeSlot}.`);
        return;
      }

      const newEntry = {
        id: Date.now(),
        date,
        ownerName,
        numAdults,
        numChildren,
        timeSlot,
        notes,
        numBreakfasts,
      };

      // POST su Google Sheet
      try {
        await fetch(SHEET_URL, {
          method: "POST",
          mode: "no-cors", // Google Apps Script non risponde con CORS, perci√≤ no-cors
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(newEntry),
        });
      } catch (err) {
        // no-cors non consente di leggere risposta, quindi errore probabile
        // ma il POST potrebbe essere andato a buon fine
        console.warn("Possibile problema nella POST, ma non possiamo verificare la risposta.", err);
      }

      this.reset();
      renderList();
      renderActiveDays();
    });

    document.getElementById("date").addEventListener("change", () => {
      const selectedDate = document.getElementById("date").value;
      const [year, month, day] = selectedDate.split("-");
      const birthdayBanner = document.getElementById("birthdayBanner");

      birthdayBanner.style.display = day === "18" && month === "12" ? "block" : "none";
      document.getElementById("formDateDesc").textContent = `Compila i dettagli per ${day}/${month}/${year}`;

      renderList();
      renderActiveDays();
    });

    window.addEventListener("load", () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("date").value = today;
      document.getElementById("date").dispatchEvent(new Event("change"));
    });
  </script>
</body>
</html>
